## ============================================
## .github/workflows/native-build.yml
## ============================================
#name: Native Build
#
#on:
#  push:
#    branches: [ main, develop ]
#  pull_request:
#    branches: [ main ]
#
#jobs:
#  # Build JVM version
#  build-jvm:
#    name: Build JVM
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#          cache: maven
#
#      - name: Build with Maven
#        run: ./mvnw clean package -DskipTests
#
#      - name: Run tests
#        run: ./mvnw test
#
#      - name: Upload JVM artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: oauth2-server-jvm
#          path: target/quarkus-app/
#
#  # Build Native Image (Linux)
#  build-native-linux:
#    name: Build Native (Linux)
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Set up GraalVM
#        uses: graalvm/setup-graalvm@v1
#        with:
#          java-version: '21'
#          distribution: 'mandrel'
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          cache: 'maven'
#
#      - name: Build Native Image
#        run: |
#          ./mvnw clean package -Pnative \
#            -DskipTests \
#            -Dquarkus.native.container-build=false \
#            -Dquarkus.native.native-image-xmx=6g
#        env:
#          MAVEN_OPTS: "-Xmx8g"
#
#      - name: Test Native Binary
#        run: |
#          ./target/*-runner --version || true
#
#      - name: Upload Native artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: oauth2-server-native-linux
#          path: target/*-runner
#
#  # Build Native Image (Container Build - Multi-platform)
#  build-native-container:
#    name: Build Native (Container)
#    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#        platform: [linux/amd64, linux/arm64]
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Set up QEMU
#        uses: docker/setup-qemu-action@v3
#
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#          cache: maven
#
#      - name: Build Native Image (Container)
#        run: |
#          ./mvnw clean package -Pnative \
#            -DskipTests \
#            -Dquarkus.native.container-build=true \
#            -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-21 \
#            -Dquarkus.native.container-runtime=docker \
#            -Dquarkus.native.native-image-xmx=6g
#        env:
#          MAVEN_OPTS: "-Xmx8g"
#
#      - name: Login to Docker Hub
#        if: github.event_name != 'pull_request'
#        uses: docker/login-action@v3
#        with:
#          username: ${{ secrets.DOCKER_USERNAME }}
#          password: ${{ secrets.DOCKER_PASSWORD }}
#
#      - name: Build and push Docker image
#        if: github.event_name != 'pull_request'
#        uses: docker/build-push-action@v5
#        with:
#          context: .
#          file: src/main/docker/Dockerfile.native
#          platforms: ${{ matrix.platform }}
#          push: true
#          tags: |
#            ${{ secrets.DOCKER_USERNAME }}/oauth2-server:native-${{ github.sha }}
#            ${{ secrets.DOCKER_USERNAME }}/oauth2-server:native-latest
#
#  # Integration Tests
#  integration-tests:
#    name: Integration Tests
#    needs: build-jvm
#    runs-on: ubuntu-latest
#    services:
#      postgres:
#        image: postgres:16-alpine
#        env:
#          POSTGRES_DB: oauth2db_test
#          POSTGRES_USER: test
#          POSTGRES_PASSWORD: test
#        ports:
#          - 5432:5432
#        options: >-
#          --health-cmd pg_isready
#          --health-interval 10s
#          --health-timeout 5s
#          --health-retries 5
#
#      redis:
#        image: redis:7-alpine
#        ports:
#          - 6379:6379
#        options: >-
#          --health-cmd "redis-cli ping"
#          --health-interval 10s
#          --health-timeout 5s
#          --health-retries 5
#
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#          cache: maven
#
#      - name: Run Integration Tests
#        run: ./mvnw verify -Dquarkus.test.profile=test
#        env:
#          DB_URL: jdbc:postgresql://localhost:5432/oauth2db_test
#          DB_USERNAME: test
#          DB_PASSWORD: test
#          REDIS_URL: redis://localhost:6379
#
#  # Security Scan
#  security-scan:
#    name: Security Scan
#    needs: build-jvm
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Run Trivy vulnerability scanner
#        uses: aquasecurity/trivy-action@master
#        with:
#          scan-type: 'fs'
#          scan-ref: '.'
#          format: 'sarif'
#          output: 'trivy-results.sarif'
#
#      - name: Upload Trivy results to GitHub Security
#        uses: github/codeql-action/upload-sarif@v3
#        with:
#          sarif_file: 'trivy-results.sarif'
#
## ============================================
## .github/workflows/release.yml
## ============================================
#---
#name: Release
#
#on:
#  push:
#    tags:
#      - 'v*'
#
#jobs:
#  release:
#    name: Create Release
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Set up GraalVM
#        uses: graalvm/setup-graalvm@v1
#        with:
#          java-version: '21'
#          distribution: 'mandrel'
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          cache: 'maven'
#
#      - name: Build Native Binaries
#        run: |
#          # Linux AMD64
#          ./mvnw clean package -Pnative \
#            -DskipTests \
#            -Dquarkus.native.container-build=true \
#            -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-21
#
#          mv target/*-runner target/oauth2-server-linux-amd64
#
#      - name: Create Release
#        uses: softprops/action-gh-release@v1
#        with:
#          files: |
#            target/oauth2-server-linux-amd64
#            target/quarkus-app/quarkus-run.jar
#          body: |
#            ## Release ${{ github.ref_name }}
#
#            ### Downloads
#            - **Native Binary (Linux AMD64)**: oauth2-server-linux-amd64
#            - **JVM JAR**: quarkus-run.jar
#
#            ### Docker Images
#            ```bash
#            docker pull ${{ secrets.DOCKER_USERNAME }}/oauth2-server:${{ github.ref_name }}
#            docker pull ${{ secrets.DOCKER_USERNAME }}/oauth2-server:native-${{ github.ref_name }}
#            ```
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
## ============================================
## .github/workflows/docker-publish.yml
## ============================================
#---
#name: Docker Publish
#
#on:
#  push:
#    branches: [ main ]
#    tags: [ 'v*' ]
#  workflow_dispatch:
#
#jobs:
#  build-and-push:
#    name: Build and Push Docker Images
#    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#        include:
#          - dockerfile: src/main/docker/Dockerfile.jvm
#            image-suffix: jvm
#          - dockerfile: src/main/docker/Dockerfile.native
#            image-suffix: native
#
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Set up QEMU
#        uses: docker/setup-qemu-action@v3
#
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#          cache: maven
#
#      - name: Build application
#        run: |
#          if [[ "${{ matrix.image-suffix }}" == "native" ]]; then
#            ./mvnw clean package -Pnative \
#              -DskipTests \
#              -Dquarkus.native.container-build=true
#          else
#            ./mvnw clean package -DskipTests
#          fi
#
#      - name: Login to Docker Hub
#        uses: docker/login-action@v3
#        with:
#          username: ${{ secrets.DOCKER_USERNAME }}
#          password: ${{ secrets.DOCKER_PASSWORD }}
#
#      - name: Extract metadata
#        id: meta
#        uses: docker/metadata-action@v5
#        with:
#          images: ${{ secrets.DOCKER_USERNAME }}/oauth2-server
#          tags: |
#            type=ref,event=branch,suffix=-${{ matrix.image-suffix }}
#            type=ref,event=pr,suffix=-${{ matrix.image-suffix }}
#            type=semver,pattern={{version}},suffix=-${{ matrix.image-suffix }}
#            type=semver,pattern={{major}}.{{minor}},suffix=-${{ matrix.image-suffix }}
#            type=raw,value=latest-${{ matrix.image-suffix }},enable={{is_default_branch}}
#
#      - name: Build and push
#        uses: docker/build-push-action@v5
#        with:
#          context: .
#          file: ${{ matrix.dockerfile }}
#          platforms: linux/amd64,linux/arm64
#          push: true
#          tags: ${{ steps.meta.outputs.tags }}
#          labels: ${{ steps.meta.outputs.labels }}
#          cache-from: type=gha
#          cache-to: type=gha,mode=max