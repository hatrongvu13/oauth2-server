# ============================================
# OAuth2 Server - Production Configuration
# Hỗ trợ K8s/K3s ConfigMap & Environment Variables
# ============================================

quarkus:
  # ============================================
  # Application Info
  # ============================================
  application:
    name: oauth2-server
    version: 1.0.0

  # ============================================
  # Native Build Configuration
  # ============================================
  native:
    additional-build-args:
      - --initialize-at-run-time=com.htv.oauth2.util.CryptoUtil$SecureRandomHolder
      - --initialize-at-run-time=java.security.SecureRandom
      - -H:+ReportExceptionStackTraces
      - --enable-all-security-services
      - --allow-incomplete-classpath

  # ============================================
  # ARC/CDI Configuration
  # ============================================
  arc:
    unremovable-types:
      - com.htv.oauth2.config.LoggingInterceptor
    exclude-types:
      - com.htv.oauth2.config.Logged

  # ============================================
  # HTTP Server Configuration
  # ============================================
  http:
    port: 8080
    host: 0.0.0.0

    # CORS Configuration
    cors:
      ~: true
      origins: "*"
      methods: GET,POST,PUT,DELETE,OPTIONS,PATCH
      headers: accept,authorization,content-type,x-requested-with,x-api-key
      exposed-headers: Content-Disposition,X-Total-Count
      access-control-max-age: 24H
      access-control-allow-credentials: true

  # ============================================
  # Database Configuration (PostgreSQL)
  # ============================================
  datasource:
    db-kind: postgresql
    username: root
    password: root

    jdbc:
      url: jdbc:postgresql://localhost:5432/oauth2db
      max-size: 16
      min-size: 4
      acquisition-timeout: 10
      idle-removal-interval: 5M
      max-lifetime: 30M
      leak-detection-interval: 5M
      validation-query-sql: SELECT 1
      enable-metrics: true

  # ============================================
  # Hibernate ORM Configuration
  # ============================================
  hibernate-orm:
    database:
      generation: none
    log:
      sql: false
      bind-parameters: false
      format-sql: false
    jdbc:
      statement-batch-size: 20

  # ============================================
  # Flyway Migration
  # ============================================
  flyway:
    migrate-at-start: true
    baseline-on-migrate: true
    locations: classpath:db/migration
    baseline-version: 1.0.0
    baseline-description: Initial baseline
    clean-at-start: false

  # ============================================
  # Redis Configuration
  # ============================================
  redis:
    hosts: redis://localhost:6379
    password: 
    database: 0
    timeout: 10s
    max-pool-size: 20
    max-pool-waiting: 24

  # ============================================
  # Cache Configuration (Caffeine)
  # ============================================
  cache:
    caffeine:
      "user-cache":
        initial-capacity: 100
        maximum-size: 1000
        expire-after-write: 10M
      "client-cache":
        initial-capacity: 50
        maximum-size: 500
        expire-after-write: 30M
      "token-cache":
        initial-capacity: 200
        maximum-size: 2000
        expire-after-write: 5M

  # ============================================
  # Logging Configuration
  # ============================================
  log:
    level: INFO
    console:
      format: >-
        %d{yyyy-MM-dd HH:mm:ss,SSS %-5p [%c{3.] (%t) %s%e%n

    # Category levels
    category:
      "com.htv.oauth2": WARN
      "org.hibernate.SQL": WARN
      "org.hibernate.type.descriptor.sql.BasicBinder": WARN
      "io.quarkus": INFO
      "io.vertx": WARN
      "org.jboss": WARN
      "org.flywaydb": INFO
      "io.quarkus.bootstrap.classloading": INFO

  # ============================================
  # Security Configuration
  # ============================================
  security:
    users:
      embedded:
        enabled: false

  # ============================================
  # JWT Configuration (SmallRye JWT)
  # ============================================
  smallrye-jwt:
    enabled: true
    issuer: ${OAUTH2_JWT_ISSUER:https://oauth2.jaxtony.store}
    new-token:
      signature-algorithm: RS256
      audience: default-client-id
      lifespan: 3600

  # ============================================
  # OpenAPI/Swagger Configuration
  # ============================================
  smallrye-openapi:
    path: /openapi
    info-title: OAuth2 Authorization Server API
    info-version: 1.0.0
    info-description: Production-ready OAuth2 Authorization Server with MFA support
    info-contact-email: hatrongvu13@gmail.com
    info-contact-name: OAuth2 Team
    servers: https://oauth2.jaxtony.store

  swagger-ui:
    always-include: true
    path: /swagger-ui
    oauth2-redirect-url: /swagger-ui/oauth2-redirect.html

  # ============================================
  # Health Check Configuration
  # ============================================
  smallrye-health:
    ui:
      enable: true
      root-path: /q/health-ui
    liveness-path: /q/health/live
    readiness-path: /q/health/ready

  # ============================================
  # Metrics Configuration (Prometheus)
  # ============================================
  micrometer:
    enabled: true
    binder:
      jvm: true
      system: true
      http-server: true
    export:
      prometheus:
        enabled: true
        path: /q/metrics
        default-registry: true

  # ============================================
  # Scheduler Configuration
  # ============================================
  scheduler:
    enabled: true
    start-mode: normal

  # ============================================
  # Container Image Configuration (for K8s)
  # ============================================
  container-image:
    registry: docker.io
    group: jaxtony
    name: oauth2-server
    tag: latest
    build: false
    push: false

  # ============================================
  # Kubernetes Configuration
  # ============================================
  kubernetes:
    deployment-target: kubernetes
    namespace: default

    # Service configuration
    service-type: ClusterIP

    # Health probes
    liveness-probe:
      http-action-path: /q/health/live
      initial-delay: 30s
      period: 10s
      timeout: 3s
      failure-threshold: 3

    readiness-probe:
      http-action-path: /q/health/ready
      initial-delay: 10s
      period: 5s
      timeout: 3s
      failure-threshold: 3

    # Resources
    resources:
      requests:
        memory: 256Mi
        cpu: 250m
      limits:
        memory: 512Mi
        cpu: 1000m

    # Environment variables from ConfigMap/Secret
    env:
      configmaps: oauth2-config
      secrets: oauth2-secret

    # Labels
    labels:
      app: oauth2-server
      version: v1
      tier: backend
  mailer:
    from: hatrongvu13@gmail.com
    host: smtp.gmail.com
    port: 587
    username: hatrongvu13@gmail.com
    password: your-app-password
    mock: false
  # Template location
  qute:
    template-path-exclude: META-INF/resources/.*$

# ============================================
# MicroProfile JWT Configuration
# ============================================
mp:
  jwt:
    verify:
      issuer: ${OAUTH2_JWT_ISSUER:https://oauth2.jaxtony.store}
      audiences: default-client-id
      publickey:
        location: classpath:keys/public_key.pem

# ============================================
# OAuth2 Custom Configuration
# ============================================
oauth2:
  # JWT Configuration
  jwt:
    access-token-expiry: 3600
    refresh-token-expiry: 86400

  # Authorization Code Configuration
  authorization-code:
    validity: 300

  # Rate Limiting Configuration
  rate-limit:
    enabled: true
    # Login attempts
    login:
      capacity: 5          # Max 5 attempts
      refill-tokens: 5     # Refill 5 tokens
      refill-period: 300   # Every 5 minutes (300s)
    # MFA verification
    mfa:
      capacity: 3          # Max 3 attempts
      refill-tokens: 3
      refill-period: 60    # Every 1 minute
    # Email sending
    email:
      capacity: 10         # Max 10 emails
      refill-tokens: 10
      refill-period: 3600  # Per hour

smallrye:
  jwt:
    sign:
      key:
        location: classpath:keys/private_key.pem
# ============================================
# Profile-specific Configuration
# ============================================
"%dev":
  quarkus:
    log:
      level: DEBUG
      category:
        "com.htv.oauth2": DEBUG
    hibernate-orm:
      log:
        sql: true
        bind-parameters: true
    http:
      cors:
        origins: "*"

"%test":
  quarkus:
    log:
      level: INFO
    datasource:
      jdbc:
        url: jdbc:postgresql://localhost:5432/oauth2db_test
    flyway:
      clean-at-start: true

"%prod":
  quarkus:
    log:
      level: INFO
      console:
        json: true
      category:
        "com.htv.oauth2": INFO
    http:
      port: 8080
      host: 0.0.0.0